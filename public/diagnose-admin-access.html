<!DOCTYPE html>
<html>
<head>
    <title>Diagnose Admin Access Issues</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDQdwrJPIl0rIMh5b9JaKOD9Zz3bNJd1R4",
            authDomain: "invoice-management-d6ea7.firebaseapp.com",
            projectId: "invoice-management-d6ea7",
            storageBucket: "invoice-management-d6ea7.appspot.com",
            messagingSenderId: "286610896823",
            appId: "1:286610896823:web:2ee1c5e7c124c1b7a8d6f7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Define expected permissions for Admin role
        const EXPECTED_ADMIN_PERMISSIONS = [
            'view_dashboard',
            'create_invoice',
            'view_invoices',
            'edit_invoices',
            'export_invoices',
            'view_customers',
            'create_customers',
            'edit_customers',
            'view_rooms',
            'create_rooms',
            'edit_rooms',
            'view_reports',
            'create_reports',
            'export_reports'
        ];

        async function diagnoseAdminAccess() {
            try {
                console.log('üîç Diagnosing Admin access issues...');
                document.getElementById('output').innerHTML += 'üîç Diagnosing Admin access issues...<br><br>';
                
                // Get all Admin users
                const adminQuery = query(collection(db, 'users'), where('role', '==', 'Admin'));
                const adminSnapshot = await getDocs(adminQuery);
                
                if (adminSnapshot.empty) {
                    document.getElementById('output').innerHTML += '‚ùå No Admin users found in database<br>';
                    return;
                }
                
                document.getElementById('output').innerHTML += `üìä Found ${adminSnapshot.size} Admin users<br><br>`;
                
                adminSnapshot.forEach(doc => {
                    const userData = doc.data();
                    
                    document.getElementById('output').innerHTML += 
                        `üë§ <strong>${userData.email}</strong><br>` +
                        `&nbsp;&nbsp;Role: ${userData.role}<br>` +
                        `&nbsp;&nbsp;isActive: ${userData.isActive}<br>` +
                        `&nbsp;&nbsp;Status: ${userData.status}<br>` +
                        `&nbsp;&nbsp;Permissions Count: ${userData.permissions ? userData.permissions.length : 0}<br><br>`;
                    
                    if (!userData.isActive) {
                        document.getElementById('output').innerHTML += '‚ö†Ô∏è <strong>ISSUE: User is not active!</strong><br><br>';
                    }
                    
                    if (!userData.permissions || userData.permissions.length === 0) {
                        document.getElementById('output').innerHTML += '‚ö†Ô∏è <strong>ISSUE: No permissions found!</strong><br><br>';
                        return;
                    }
                    
                    // Check specific access permissions
                    const accessChecks = {
                        'canViewInvoices': userData.permissions.includes('view_invoices'),
                        'canCreateInvoices': userData.permissions.includes('create_invoice'),
                        'canViewCustomers': userData.permissions.includes('view_customers'),
                        'canViewRooms': userData.permissions.includes('view_rooms')
                    };
                    
                    document.getElementById('output').innerHTML += 'üîç <strong>Access Check Results:</strong><br>';
                    Object.entries(accessChecks).forEach(([check, hasAccess]) => {
                        const emoji = hasAccess ? '‚úÖ' : '‚ùå';
                        const issue = hasAccess ? '' : ' <strong>(ISSUE!)</strong>';
                        document.getElementById('output').innerHTML += `&nbsp;&nbsp;${emoji} ${check}: ${hasAccess}${issue}<br>`;
                    });
                    
                    document.getElementById('output').innerHTML += '<br>';
                    
                    // Check missing permissions
                    const missingPermissions = EXPECTED_ADMIN_PERMISSIONS.filter(perm => 
                        !userData.permissions.includes(perm)
                    );
                    
                    if (missingPermissions.length > 0) {
                        document.getElementById('output').innerHTML += '‚ö†Ô∏è <strong>Missing Permissions:</strong><br>';
                        missingPermissions.forEach(perm => {
                            document.getElementById('output').innerHTML += `&nbsp;&nbsp;‚ùå ${perm}<br>`;
                        });
                        document.getElementById('output').innerHTML += '<br>';
                    } else {
                        document.getElementById('output').innerHTML += '‚úÖ <strong>All expected permissions present</strong><br><br>';
                    }
                    
                    // Check extra permissions
                    const extraPermissions = userData.permissions.filter(perm => 
                        !EXPECTED_ADMIN_PERMISSIONS.includes(perm)
                    );
                    
                    if (extraPermissions.length > 0) {
                        document.getElementById('output').innerHTML += '‚ÑπÔ∏è <strong>Extra Permissions:</strong><br>';
                        extraPermissions.forEach(perm => {
                            document.getElementById('output').innerHTML += `&nbsp;&nbsp;+ ${perm}<br>`;
                        });
                        document.getElementById('output').innerHTML += '<br>';
                    }
                    
                    document.getElementById('output').innerHTML += '---<br><br>';
                });
                
                document.getElementById('output').innerHTML += 
                    '<strong>üîß Common Issues & Solutions:</strong><br>' +
                    '1. User not active ‚Üí Check isActive field<br>' +
                    '2. Missing permissions ‚Üí Run permission update<br>' +
                    '3. Wrong role assignment ‚Üí Check role field<br>' +
                    '4. Browser cache ‚Üí Clear browser cache and refresh<br><br>' +
                    '<strong>Expected Admin Access:</strong><br>' +
                    '‚úÖ View/Create/Edit Invoices<br>' +
                    '‚úÖ View/Create/Edit Customers<br>' +
                    '‚úÖ View/Create/Edit Rooms<br>' +
                    '‚úÖ View/Create Reports<br>' +
                    '‚ùå User Management (MasterAdmin only)<br>' +
                    '‚ùå Delete operations (FullAdmin+ only)<br>';
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                document.getElementById('output').innerHTML += `‚ùå Error: ${error.message}<br>`;
            }
        }

        window.addEventListener('load', () => {
            document.getElementById('diagnoseButton').addEventListener('click', diagnoseAdminAccess);
        });
    </script>
</head>
<body>
    <h1>Admin Access Diagnosis</h1>
    <p>This tool will diagnose why Admin users cannot access invoices, customers, rooms, and create invoice functionality.</p>
    
    <button id="diagnoseButton">Diagnose Admin Access Issues</button>
    
    <h2>Diagnosis Results:</h2>
    <div id="output" style="background: #f5f5f5; padding: 10px; min-height: 200px; font-family: monospace; white-space: pre-wrap; max-height: 600px; overflow-y: auto;"></div>
</body>
</html>